import{_ as z,r as d,c as _,m as B,a as o,b as s,q as I,x as A,F as S,k as D,t as n,A as U,o as l,n as T,e as N,g as u}from"./index-BPhHBPve.js";import{E as H}from"./experience.service-ClOJtLbE.js";import"./httpClient-DpjTLT7X.js";const J={class:"agency-reservations"},O={class:"header"},G={class:"filters"},K=["value"],Q={key:0,class:"loading"},W={key:1,class:"error"},X={key:2,class:"content"},Y={class:"stats"},Z={class:"stat-card"},ee={class:"stat-number"},se={class:"stat-card"},te={class:"stat-number"},ae={class:"stat-card"},ne={class:"stat-number"},oe={class:"stat-card"},le={class:"stat-number"},ie={key:0,class:"empty-state"},re={key:0},de={key:1},ce={key:1,class:"reservations-list"},ue={class:"reservation-header"},ve={class:"reservation-info"},pe={class:"experience-title"},me={class:"reservation-date"},fe={class:"reservation-location"},ge={class:"reservation-status"},ye={class:"reservation-price"},_e={class:"reservation-details"},he={class:"customer-info"},be={class:"customer-name"},ke={class:"participants"},Re={class:"booking-date"},xe={key:0,class:"reservation-actions"},Ce=["onClick","disabled"],Ee=["onClick","disabled"],we={key:0,class:"special-requests"},Ie={__name:"agency-reservations.page",setup(Ae){const P=new H,i=d([]),m=d([]),b=d([]),h=d(!0),f=d(null),g=d(!1),v=d(""),p=d(""),k=_(()=>{let a=[...i.value];return v.value&&(a=a.filter(e=>e.status===v.value)),p.value&&(a=a.filter(e=>e.experienceId===p.value)),a.sort((e,t)=>new Date(t.bookingDate)-new Date(e.bookingDate))}),q=_(()=>i.value.filter(a=>a.status==="pending").length),V=_(()=>i.value.filter(a=>a.status==="confirmed").length),$=_(()=>`€${i.value.filter(e=>e.status==="confirmed").reduce((e,t)=>e+(t.totalPrice||0),0)}`),F=async()=>{try{h.value=!0,f.value=null;const a=U.fromStorage();if(!(a!=null&&a.isAgency()))throw new Error("Acceso denegado: Solo para agencias");const e=await P.getAllExperiences();m.value=e.filter(r=>{var w;return(r.agencyId||((w=r.agency)==null?void 0:w.id))===a.userId}),console.log("[AgencyReservations] My experiences:",m.value);const c=await(await fetch("http://localhost:3003/reservations")).json(),y=m.value.map(r=>r.id);i.value=c.filter(r=>y.includes(r.experienceId)),console.log("[AgencyReservations] Filtered reservations:",i.value);const j=await(await fetch("http://localhost:3003/users")).json();b.value=j.filter(r=>r.role==="tourist")}catch(a){console.error("[AgencyReservations] Error loading reservations:",a),f.value=a.message}finally{h.value=!1}},R=async(a,e)=>{try{if(g.value=!0,(await fetch(`http://localhost:3003/reservations/${a}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:e})})).ok){const c=i.value.findIndex(E=>E.id===a);c!==-1&&(i.value[c].status=e),alert(`Reserva ${e==="confirmed"?"confirmada":"cancelada"} exitosamente`)}else throw new Error("Error al actualizar el estado de la reserva")}catch(t){console.error("[AgencyReservations] Error updating reservation:",t),alert("Error al actualizar el estado de la reserva")}finally{g.value=!1}},L=a=>{const e=b.value.find(t=>t.id===a);return(e==null?void 0:e.name)||"Cliente no encontrado"},M=a=>({pending:"Pendiente",confirmed:"Confirmada",cancelled:"Cancelada"})[a]||a,x=a=>a?new Date(a).toLocaleDateString("es-ES",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}):"Fecha no disponible",C=()=>{};return B(()=>{F()}),(a,e)=>(l(),o("div",J,[s("div",O,[e[4]||(e[4]=s("div",null,[s("h1",null,"Mis Reservas"),s("p",{class:"subtitle"},"Reservas de tus experiencias")],-1)),s("div",G,[I(s("select",{"onUpdate:modelValue":e[0]||(e[0]=t=>v.value=t),onChange:C,class:"filter-select"},e[2]||(e[2]=[s("option",{value:""},"Todos los estados",-1),s("option",{value:"pending"},"Pendientes",-1),s("option",{value:"confirmed"},"Confirmadas",-1),s("option",{value:"cancelled"},"Canceladas",-1)]),544),[[A,v.value]]),I(s("select",{"onUpdate:modelValue":e[1]||(e[1]=t=>p.value=t),onChange:C,class:"filter-select"},[e[3]||(e[3]=s("option",{value:""},"Todas las experiencias",-1)),(l(!0),o(S,null,D(m.value,t=>(l(),o("option",{key:t.id,value:t.id},n(t.title),9,K))),128))],544),[[A,p.value]])])]),h.value?(l(),o("div",Q,e[5]||(e[5]=[s("i",{class:"pi pi-spinner pi-spin"},null,-1),s("span",null,"Cargando reservas...",-1)]))):f.value?(l(),o("div",W,[e[6]||(e[6]=s("i",{class:"pi pi-exclamation-triangle"},null,-1)),s("span",null,n(f.value),1)])):(l(),o("div",X,[s("div",Y,[s("div",Z,[s("div",ee,n(i.value.length),1),e[7]||(e[7]=s("div",{class:"stat-label"},"Total Reservas",-1))]),s("div",se,[s("div",te,n(q.value),1),e[8]||(e[8]=s("div",{class:"stat-label"},"Pendientes",-1))]),s("div",ae,[s("div",ne,n(V.value),1),e[9]||(e[9]=s("div",{class:"stat-label"},"Confirmadas",-1))]),s("div",oe,[s("div",le,n($.value),1),e[10]||(e[10]=s("div",{class:"stat-label"},"Ingresos Total",-1))])]),k.value.length===0?(l(),o("div",ie,[e[11]||(e[11]=s("i",{class:"pi pi-calendar-times"},null,-1)),e[12]||(e[12]=s("h3",null,"No hay reservas",-1)),v.value||p.value?(l(),o("p",re," No hay reservas que coincidan con los filtros seleccionados. ")):(l(),o("p",de," Aún no tienes reservas para tus experiencias. "))])):(l(),o("div",ce,[(l(!0),o(S,null,D(k.value,t=>{var c;return l(),o("div",{key:t.id,class:T(["reservation-card",{pending:t.status==="pending",confirmed:t.status==="confirmed",cancelled:t.status==="cancelled"}])},[s("div",ue,[s("div",ve,[s("h3",pe,n(t.experienceTitle),1),s("p",me,[e[13]||(e[13]=s("i",{class:"pi pi-calendar"},null,-1)),u(" "+n(x(t.date)),1)]),s("p",fe,[e[14]||(e[14]=s("i",{class:"pi pi-map-marker"},null,-1)),u(" "+n(t.experienceLocation),1)])]),s("div",ge,[s("span",{class:T(["status-badge",t.status])},n(M(t.status)),3),s("div",ye," €"+n(t.totalPrice),1)])]),s("div",_e,[s("div",he,[e[18]||(e[18]=s("h4",null,"Información del Cliente",-1)),s("p",be,[e[15]||(e[15]=s("i",{class:"pi pi-user"},null,-1)),u(" "+n(L(t.userId)),1)]),s("p",ke,[e[16]||(e[16]=s("i",{class:"pi pi-users"},null,-1)),u(" "+n(t.participants)+" participante(s) ",1)]),s("p",Re,[e[17]||(e[17]=s("i",{class:"pi pi-clock"},null,-1)),u(" Reservado el "+n(x(t.bookingDate)),1)])]),t.status==="pending"?(l(),o("div",xe,[s("button",{onClick:y=>R(t.id,"confirmed"),class:"btn-confirm",disabled:g.value},e[19]||(e[19]=[s("i",{class:"pi pi-check"},null,-1),u(" Confirmar ")]),8,Ce),s("button",{onClick:y=>R(t.id,"cancelled"),class:"btn-cancel",disabled:g.value},e[20]||(e[20]=[s("i",{class:"pi pi-times"},null,-1),u(" Cancelar ")]),8,Ee)])):N("",!0)]),(c=t.customerInfo)!=null&&c.specialRequests?(l(),o("div",we,[e[21]||(e[21]=s("h4",null,"Solicitudes Especiales",-1)),s("p",null,n(t.customerInfo.specialRequests),1)])):N("",!0)],2)}),128))]))]))]))}},Pe=z(Ie,[["__scopeId","data-v-a653508a"]]);export{Pe as default};
